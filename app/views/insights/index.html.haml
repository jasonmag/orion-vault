%body.bg-background
  .bg-background
    .relative.isolate.px-6.pt-8.lg:px-8.mx-auto
      .mx-auto.max-w-5xl.py-16.sm:py-24.lg:py-28
        .flex.items-center.justify-between.mb-6
          %h1.text-2xl.font-bold Insights
          = link_to expenses_path, class: "text-black underline" do
            View Expenses

        .grid.grid-cols-1.md:grid-cols-3.gap-6.mb-10
          .rounded-lg.border.border-gray-200.bg-white.p-5
            %p.text-sm.text-gray-500 Total cash-out (last 6 months)
            %p.text-2xl.font-semibold.text-gray-900
              = Money.new(@total_spend * 100, current_user.user_setting.default_currency).format(symbol: true, with_currency: false)
          .rounded-lg.border.border-gray-200.bg-white.p-5
            %p.text-sm.text-gray-500 Cash-in (last 6 months)
            %p.text-2xl.font-semibold.text-gray-900
              = Money.new(@total_cash_in * 100, current_user.user_setting.default_currency).format(symbol: true, with_currency: false)
          .rounded-lg.border.border-gray-200.bg-white.p-5
            %p.text-sm.text-gray-500 Net (cash-in minus cash-out)
            %p.text-2xl.font-semibold.text-gray-900
              = Money.new(@net_total * 100, current_user.user_setting.default_currency).format(symbol: true, with_currency: false)

        .rounded-xl.border.border-gray-200.bg-white.p-6
          .flex.items-center.justify-between.mb-4
            %div
              %h2.text-lg.font-semibold Monthly cashflow comparison
              %p.text-sm.text-gray-500 Cash-in vs payments done (due + manual), last 6 months
            .flex.items-center.gap-4.text-sm.text-gray-600
              .flex.items-center.gap-2
                %span.inline-block.h-3.w-3.rounded-full.bg-emerald-500
                Payments done (due)
              .flex.items-center.gap-2
                %span.inline-block.h-3.w-3.rounded-full.bg-amber-400
                Payments done (manual)
              .flex.items-center.gap-2
                %span.inline-block.h-3.w-3.rounded-full.bg-sky-500
                Cash-in

          - if @max_spend.zero? && @max_cash_in.zero?
            %p.text-sm.text-gray-600 No cash activity in the last 6 months.
          - else
            .space-y-4
              - @monthly_rows.each do |row|
                - max_value = @max_cashflow_value.to_f
                - payable_width = max_value.positive? ? ((row[:total_spend].to_f / max_value) * 100).round(2) : 0
                - cash_in_width = max_value.positive? ? ((row[:cash_in].to_f / max_value) * 100).round(2) : 0
                - payment_done_width = max_value.positive? ? ((row[:due].to_f / max_value) * 100).round(2) : 0
                - payable_width = [payable_width, 100].min
                - cash_in_width = [cash_in_width, 100].min
                - payment_done_width = [payment_done_width, 100].min
                - net = row[:cash_in] - row[:total_spend]
                .grid.grid-cols-12.items-center.gap-3
                  %div.col-span-3.text-sm.font-semibold.text-gray-700= row[:month]
                  .col-span-6
                    .space-y-3
                      - payment_done_amount = Money.new(row[:due] * 100, current_user.user_setting.default_currency).format(symbol: true, with_currency: false)
                      - cash_in_amount = Money.new(row[:cash_in] * 100, current_user.user_setting.default_currency).format(symbol: true, with_currency: false)
                      - payable_amount = Money.new(row[:total_spend] * 100, current_user.user_setting.default_currency).format(symbol: true, with_currency: false)

                      .relative.group
                        .h-2.w-full.bg-gray-100.rounded-full.overflow-hidden
                          .h-2.bg-emerald-500.rounded-full.block{ style: "width: #{payment_done_width}%" }
                        %div{ class: "absolute -top-9 left-0 hidden group-hover:block rounded-md bg-gray-900 px-2 py-1 text-[11px] text-white shadow-lg whitespace-nowrap" }
                          = "Payment done · #{payment_done_amount}"

                      .relative.group
                        .h-2.w-full.bg-gray-100.rounded-full.overflow-hidden
                          .h-2.bg-sky-500.rounded-full.block{ style: "width: #{cash_in_width}%" }
                        %div{ class: "absolute -top-9 left-0 hidden group-hover:block rounded-md bg-gray-900 px-2 py-1 text-[11px] text-white shadow-lg whitespace-nowrap" }
                          = "Cash-in · #{cash_in_amount}"

                      .relative.group
                        .h-2.w-full.bg-gray-100.rounded-full.overflow-hidden
                          .h-2.bg-rose-500.rounded-full.block{ style: "width: #{payable_width}%" }
                        %div{ class: "absolute -top-9 left-0 hidden group-hover:block rounded-md bg-gray-900 px-2 py-1 text-[11px] text-white shadow-lg whitespace-nowrap" }
                          = "Payable · #{payable_amount}"
                  .col-span-3.text-right
                    %div.text-xs.text-gray-500 Net
                    - net_class = net.negative? ? "text-rose-600" : "text-emerald-600"
                    %div.text-sm.font-semibold{ class: net_class }
                      = Money.new(net * 100, current_user.user_setting.default_currency).format(symbol: true, with_currency: false)
