%body.bg-background
  .bg-background
    .relative.isolate.px-6.pt-8.lg:px-8.mx-auto
      .mx-auto.max-w-5xl.py-16.sm:py-24.lg:py-28
        .flex.items-center.justify-between.mb-6
          %h1.text-2xl.font-bold Insights
          = link_to expenses_path, class: "text-black underline" do
            View Expenses

        .grid.grid-cols-1.md:grid-cols-3.gap-6.mb-10
          .rounded-lg.border.border-gray-200.bg-white.p-5
            %p.text-sm.text-gray-500 Total cash-out (last 6 months)
            %p.text-2xl.font-semibold.text-gray-900
              = Money.new(@total_spend * 100, current_user.user_setting.default_currency).format(symbol: true, with_currency: false)
          .rounded-lg.border.border-gray-200.bg-white.p-5
            %p.text-sm.text-gray-500 Cash-in (last 6 months)
            %p.text-2xl.font-semibold.text-gray-900
              = Money.new(@total_cash_in * 100, current_user.user_setting.default_currency).format(symbol: true, with_currency: false)
          .rounded-lg.border.border-gray-200.bg-white.p-5
            %p.text-sm.text-gray-500 Net (cash-in minus cash-out)
            %p.text-2xl.font-semibold.text-gray-900
              = Money.new(@net_total * 100, current_user.user_setting.default_currency).format(symbol: true, with_currency: false)

        .rounded-xl.border.border-gray-200.bg-white.p-6
          .flex.items-center.justify-between.mb-4
            %div
              %h2.text-lg.font-semibold Monthly cashflow comparison
              %p.text-sm.text-gray-500 Cash-in vs payments done (due + manual), last 6 months
            .flex.items-center.gap-4.text-sm.text-gray-600
              .flex.items-center.gap-2
                %span.inline-block.h-3.w-3.rounded-full.bg-emerald-500
                Payments done (due)
              .flex.items-center.gap-2
                %span.inline-block.h-3.w-3.rounded-full.bg-amber-400
                Payments done (manual)
              .flex.items-center.gap-2
                %span.inline-block.h-3.w-3.rounded-full.bg-sky-500
                Cash-in

          - if @max_spend.zero? && @max_cash_in.zero?
            %p.text-sm.text-gray-600 No cash activity in the last 6 months.
          - else
            - chart_width = 640
            - chart_height = 240
            - padding = 28
            - max_value = @max_cashflow_value.to_f
            - x_step = @monthly_rows.size > 1 ? (chart_width - (padding * 2)).fdiv(@monthly_rows.size - 1) : 0
            - y_for = ->(value) { max_value.zero? ? (chart_height - padding) : (chart_height - padding - ((value.to_f / max_value) * (chart_height - (padding * 2)))).round(2) }
            - due_coords = @monthly_rows.map.with_index { |row, index| [(padding + (index * x_step)).round(2), y_for.call(row[:due])] }
            - manual_coords = @monthly_rows.map.with_index { |row, index| [(padding + (index * x_step)).round(2), y_for.call(row[:manual])] }
            - cash_in_coords = @monthly_rows.map.with_index { |row, index| [(padding + (index * x_step)).round(2), y_for.call(row[:cash_in])] }
            - due_points = due_coords.map { |point| "#{point[0]},#{point[1]}" }.join(" ")
            - manual_points = manual_coords.map { |point| "#{point[0]},#{point[1]}" }.join(" ")
            - cash_in_points = cash_in_coords.map { |point| "#{point[0]},#{point[1]}" }.join(" ")
            - spline_path = lambda do |points|
              - next "" if points.empty?
              - return "M #{points[0][0]},#{points[0][1]}" if points.length == 1
              - path = +"M #{points[0][0]},#{points[0][1]}"
              - points.each_with_index do |point, index|
                - next if index == 0
                - p0 = points[index - 2] || points[index - 1]
                - p1 = points[index - 1]
                - p2 = point
                - p3 = points[index + 1] || point
                - c1x = (p1[0] + (p2[0] - p0[0]) / 6.0).round(2)
                - c1y = (p1[1] + (p2[1] - p0[1]) / 6.0).round(2)
                - c2x = (p2[0] - (p3[0] - p1[0]) / 6.0).round(2)
                - c2y = (p2[1] - (p3[1] - p1[1]) / 6.0).round(2)
                - path << " C #{c1x},#{c1y} #{c2x},#{c2y} #{p2[0]},#{p2[1]}"
              - path
            - cash_in_spline = spline_path.call(cash_in_coords)
            - due_spline = spline_path.call(due_coords)
            - manual_spline = spline_path.call(manual_coords)

            .space-y-4{ data: { controller: "frequency-tabs" } }
              .inline-flex.rounded-md.shadow-sm{ role: "tablist" }
                %button.px-4.py-2.text-sm.font-semibold.border.border-gray-300.rounded-l-md{ type: "button", role: "tab", aria: { selected: "true", controls: "cashflow-panel-line" }, data: { action: "click->frequency-tabs#show", frequency_tabs_target: "tab", frequency_value: "line", active: "true", active_class: "bg-gray-900 text-white border-gray-900", inactive_class: "bg-white text-gray-700 hover:bg-gray-50" } } Line
                %button.px-4.py-2.text-sm.font-semibold.border.border-gray-300.rounded-r-md.-ml-px{ type: "button", role: "tab", aria: { selected: "false", controls: "cashflow-panel-spline" }, data: { action: "click->frequency-tabs#show", frequency_tabs_target: "tab", frequency_value: "spline", active_class: "bg-gray-900 text-white border-gray-900", inactive_class: "bg-white text-gray-700 hover:bg-gray-50" } } Spline

              %section.rounded-lg.border.border-gray-100.bg-white.p-4{ id: "cashflow-panel-line", role: "tabpanel", data: { frequency_tabs_target: "panel", frequency: "line" } }
                %svg{ class: "w-full h-64", viewBox: "0 0 #{chart_width} #{chart_height}", role: "img", "aria-label": "Monthly cashflow line chart" }
                  %defs
                    %linearGradient{ id: "cash-in-gradient", x1: "0", y1: "0", x2: "0", y2: "1" }
                      %stop{ offset: "0%", "stop-color": "#0ea5e9", "stop-opacity": "0.25" }
                      %stop{ offset: "100%", "stop-color": "#0ea5e9", "stop-opacity": "0.02" }
                  -# Grid lines
                  - (0..3).each do |index|
                    - y = padding + ((chart_height - (padding * 2)) * index / 3.0)
                    %line{ x1: padding, x2: chart_width - padding, y1: y, y2: y, stroke: "#e5e7eb", "stroke-width": "1" }
                  -# Cash-in area
                  %path{ d: "M #{cash_in_points} L #{chart_width - padding},#{chart_height - padding} L #{padding},#{chart_height - padding} Z", fill: "url(#cash-in-gradient)" }
                  %polyline{ points: cash_in_points, fill: "none", stroke: "#0ea5e9", "stroke-width": "2.5" }
                  %polyline{ points: due_points, fill: "none", stroke: "#10b981", "stroke-width": "2.5" }
                  %polyline{ points: manual_points, fill: "none", stroke: "#f59e0b", "stroke-width": "2.5", "stroke-dasharray": "6 4" }

                  - @monthly_rows.each_with_index do |row, index|
                    - x = (padding + (index * x_step)).round(2)
                    - due_y = y_for.call(row[:due])
                    - manual_y = y_for.call(row[:manual])
                    - cash_in_y = y_for.call(row[:cash_in])
                    %circle{ cx: x, cy: cash_in_y, r: "3", fill: "#0ea5e9" }
                    %circle{ cx: x, cy: due_y, r: "3", fill: "#10b981" }
                    %circle{ cx: x, cy: manual_y, r: "3", fill: "#f59e0b" }

                  -# X-axis labels
                  - @monthly_rows.each_with_index do |row, index|
                    - x = (padding + (index * x_step)).round(2)
                    %text{ x: x, y: chart_height - 6, "text-anchor": "middle", "font-size": "11", fill: "#6b7280" }= row[:month]

              %section.rounded-lg.border.border-gray-100.bg-white.p-4.hidden{ id: "cashflow-panel-spline", role: "tabpanel", data: { frequency_tabs_target: "panel", frequency: "spline" } }
                %svg{ class: "w-full h-64", viewBox: "0 0 #{chart_width} #{chart_height}", role: "img", "aria-label": "Monthly cashflow spline chart" }
                  %defs
                    %linearGradient{ id: "cash-in-spline-gradient", x1: "0", y1: "0", x2: "0", y2: "1" }
                      %stop{ offset: "0%", "stop-color": "#0ea5e9", "stop-opacity": "0.25" }
                      %stop{ offset: "100%", "stop-color": "#0ea5e9", "stop-opacity": "0.02" }
                  -# Grid lines
                  - (0..3).each do |index|
                    - y = padding + ((chart_height - (padding * 2)) * index / 3.0)
                    %line{ x1: padding, x2: chart_width - padding, y1: y, y2: y, stroke: "#e5e7eb", "stroke-width": "1" }
                  -# Cash-in spline area
                  %path{ d: "#{cash_in_spline} L #{chart_width - padding},#{chart_height - padding} L #{padding},#{chart_height - padding} Z", fill: "url(#cash-in-spline-gradient)" }
                  %path{ d: cash_in_spline, fill: "none", stroke: "#0ea5e9", "stroke-width": "2.5" }
                  %path{ d: due_spline, fill: "none", stroke: "#10b981", "stroke-width": "2.5" }
                  %path{ d: manual_spline, fill: "none", stroke: "#f59e0b", "stroke-width": "2.5", "stroke-dasharray": "6 4" }

                  - @monthly_rows.each_with_index do |row, index|
                    - x = (padding + (index * x_step)).round(2)
                    - due_y = y_for.call(row[:due])
                    - manual_y = y_for.call(row[:manual])
                    - cash_in_y = y_for.call(row[:cash_in])
                    %circle{ cx: x, cy: cash_in_y, r: "3", fill: "#0ea5e9" }
                    %circle{ cx: x, cy: due_y, r: "3", fill: "#10b981" }
                    %circle{ cx: x, cy: manual_y, r: "3", fill: "#f59e0b" }

                  -# X-axis labels
                  - @monthly_rows.each_with_index do |row, index|
                    - x = (padding + (index * x_step)).round(2)
                    %text{ x: x, y: chart_height - 6, "text-anchor": "middle", "font-size": "11", fill: "#6b7280" }= row[:month]

            .grid.grid-cols-1.sm:grid-cols-3.gap-4.mt-6
              - @monthly_rows.each do |row|
                - net = row[:cash_in] - row[:total_spend]
                .rounded-md.border.border-gray-100.bg-gray-50.p-3
                  %div.text-xs.font-semibold.text-gray-500= row[:month]
                  %div.text-sm.text-gray-700
                    = "Due: #{Money.new(row[:due] * 100, current_user.user_setting.default_currency).format(symbol: true, with_currency: false)}"
                  %div.text-sm.text-gray-700
                    = "Manual: #{Money.new(row[:manual] * 100, current_user.user_setting.default_currency).format(symbol: true, with_currency: false)}"
                  %div.text-sm.text-gray-700
                    = "Cash-in: #{Money.new(row[:cash_in] * 100, current_user.user_setting.default_currency).format(symbol: true, with_currency: false)}"
                  - net_class = net.negative? ? "text-rose-600" : "text-emerald-600"
                  %div.text-sm.font-semibold{ class: net_class }
                    = "Net: #{Money.new(net * 100, current_user.user_setting.default_currency).format(symbol: true, with_currency: false)}"
